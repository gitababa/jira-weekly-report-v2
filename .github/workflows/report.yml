name: Weekly Jira Report

on:
  # Exact 10:00 Europe/Berlin all year:
  # - CET months (Nov–Mar): 10:00 CET == 09:00 UTC
  # - CEST months (Apr–Oct): 10:00 CEST == 08:00 UTC
  schedule:
    - cron: '0 9 * 11,12,1,2,3 MON'   # Nov–Mar Mondays 09:00 UTC → 10:00 CET
    - cron: '0 8 * 4,5,6,7,8,9,10 MON' # Apr–Oct Mondays 08:00 UTC → 10:00 CEST

  # Manual trigger (optionally override dates or mock today)
  workflow_dispatch:
    inputs:
      start:
        description: 'Start date (YYYY-MM-DD), optional'
        required: false
      end:
        description: 'End date (YYYY-MM-DD), optional'
        required: false
      mock_today:
        description: 'Mock today (YYYY-MM-DD) for testing Monday logic, optional'
        required: false

jobs:
  report:
    runs-on: ubuntu-latest
    concurrency:
      group: weekly-jira-report
      cancel-in-progress: false

    env:
      CONFIG_PATH: config.json

      # Jira
      JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
      JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # SMTP
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      SMTP_HOST:  ${{ secrets.SMTP_HOST }}
      SMTP_PORT:  ${{ secrets.SMTP_PORT }}
      SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}

      # Optional: test the “it’s Monday” path without changing code
      # (used only on manual runs if provided)
      REPORT_MOCK_TODAY: ${{ github.event.inputs.mock_today }}

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run report
        run: |
          # If workflow_dispatch provided dates, pass them to main.py (if your main supports CLI)
          if [ -n "${{ github.event.inputs.start }}" ] && [ -n "${{ github.event.inputs.end }}" ]; then
            echo "Manual override window: ${{ github.event.inputs.start }} → ${{ github.event.inputs.end }}"
            python main.py --start "${{ github.event.inputs.start }}" --end "${{ github.event.inputs.end }}"
          else
            python main.py
          fi
