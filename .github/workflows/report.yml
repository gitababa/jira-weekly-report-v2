name: Weekly Jira Report

on:
  # Run manually from the Actions tab (great for testing)
  workflow_dispatch:
    inputs:
      start:
        description: 'Start date (YYYY-MM-DD). Leave empty to use config.json'
        required: false
        default: ''
      end:
        description: 'End date (YYYY-MM-DD). Leave empty to use config.json'
        required: false
        default: ''

  # Run every Monday morning
  # NOTE: GitHub cron uses UTC. 09:00 UTC ~= 10:00 Europe/Berlin in winter (CET),
  # but will be 11:00 in summer (CEST). See note below for options.
  schedule:
    - cron: '0 9 * * MON'

jobs:
  send-report:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      # Make root imports like "from jira import JiraClient" work
      PYTHONPATH: .
      CONFIG_PATH: config.json

      # Jira / SMTP come from repo or environment secrets
      JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
      JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Optional: show which config will be used
      - name: Show config.json
        run: cat config.json

      # Optional: override window from the "Run workflow" form
      - name: Optionally override window from inputs
        if: ${{ github.event.inputs.start != '' && github.event.inputs.end != '' }}
        run: |
          python - <<'PY'
          import json, os
          cfg_path = os.environ.get("CONFIG_PATH","config.json")
          with open(cfg_path,'r',encoding='utf-8') as f:
              cfg = json.load(f)
          cfg['report']['window']['mode'] = 'custom_range'
          cfg['report']['window']['start'] = '${{ github.event.inputs.start }}'
          cfg['report']['window']['end']   = '${{ github.event.inputs.end }}'
          with open(cfg_path,'w',encoding='utf-8') as f:
              json.dump(cfg,f,indent=2)
          print("Window overridden:", cfg['report']['window'])
          PY

      - name: Run Jira report
        run: python main.py
